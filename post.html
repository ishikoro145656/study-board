<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æŠ•ç¨¿è©³ç´°</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { font-family: "Inter","Segoe UI",Tahoma,Geneva,Verdana,sans-serif; background:#f0fff4; color:#2a4d14; margin:0; }
  header { background:#4caf50; color:#fff; padding:1rem; text-align:center; font-weight:bold; position:sticky; top:0; z-index:100; }
  .container { max-width:720px; margin:1rem auto; background:#fff; border-radius:12px; padding:1rem 1.2rem; box-shadow:0 2px 12px rgba(0,0,0,.1); }
  .post-box { border:1px solid #ddd; border-radius:10px; padding:1rem; margin-bottom:1rem; }
  .post-head { display:flex; gap:.6rem; align-items:center; margin-bottom:.5rem; }
  .post-head img { width:40px; height:40px; border-radius:50%; }
  .meta { font-size:.85rem; color:#555; }
  .hashtags { margin-top:.4rem; display:flex; flex-wrap:wrap; gap:.4rem; }
  .tag { font-size:.85rem; padding:.1rem .5rem; border-radius:12px; background:#e8f5e9; cursor:pointer; user-select:none; }
  .reply { border-bottom:1px solid #eee; padding:.7rem 0; }
  .reply.self { background:#e8f5e9; border-radius:8px; padding:.7rem; }
  .reply img { max-width:200px; max-height:120px; display:block; margin-top:.4rem; border-radius:4px; }
  .reply-list { margin-bottom:1rem; }
  .editor { border-top:1px dashed #c8e6c9; padding-top:1rem; }
  .row { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
  input, select, textarea, button { font-size:1rem; }
  textarea { width:100%; min-height:90px; box-sizing:border-box; }
  input[type="text"] { width:100%; box-sizing:border-box; }
  button { background:#4caf50; color:#fff; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; }
  button:disabled { background:#a5d6a7; cursor:not-allowed; }
  .danger { background:#c62828; }
  .muted { color:#666; font-size:.9rem; }
  .back { display:inline-block; margin:.6rem 0 0 0; text-decoration:none; }
</style>
</head>
<body>
<header>æŠ•ç¨¿è©³ç´°</header>
<div class="container">
  <a class="back" href="index.html">â† ä¸€è¦§ã¸æˆ»ã‚‹</a>

  <div id="post-box" class="post-box">
    <div class="post-head">
      <img id="post-icon" alt="icon" />
      <div>
        <div><strong id="post-user"></strong> <span class="muted" id="post-grade"></span></div>
        <div class="meta" id="post-time"></div>
      </div>
    </div>
    <div class="meta"><strong>æ•™ç§‘:</strong> <span id="post-subject"></span></div>
    <div id="post-content" style="white-space:pre-wrap;margin:.4rem 0;"></div>
    <img id="post-image" style="display:none; max-width:260px; max-height:160px; border-radius:6px;" />
    <div id="post-tags" class="hashtags"></div>

    <div id="post-actions" style="margin-top:.6rem;">
      <button id="good-btn">ğŸ‘ <span id="good-count">0</span></button>
      <button id="delete-btn" style="background:#c62828; color:#fff; display:none;">å‰Šé™¤</button>
    </div>
    

    <!-- æŠ•ç¨¿è€…é™å®šã‚¨ãƒªã‚¢ -->
    <div id="owner-tools" style="display:none; margin-top:.8rem; padding-top:.6rem; border-top:1px solid #ddd;">
      <div class="row">
        <label>æŠ•ç¨¿ç®±ã®èƒŒæ™¯è‰²:
          <select id="color-select">
            <option value="#ffffff">ç™½</option>
            <option value="#e8f5e9">è–„ã„ç·‘</option>
            <option value="#e3f2fd">è–„ã„é’</option>
            <option value="#fff8e1">è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸</option>
            <option value="#fce4ec">è–„ã„ãƒ”ãƒ³ã‚¯</option>
          </select>
        </label>
        <button id="save-color-btn">è‰²ã‚’ä¿å­˜</button>
      </div>
      <div class="row" style="margin-top:.6rem; width:100%;">
        <label style="width:100%;">ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ç·¨é›†ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šãƒ»ã€Œ#ã€ã‹ã‚‰ï¼‰</label>
        <input id="tag-input" type="text" placeholder="#æ•°å­¦ #ãƒ†ã‚¹ãƒˆå¯¾ç­–" />
        <button id="save-tags-btn">ã‚¿ã‚°ã‚’ä¿å­˜</button>
      </div>
      <div id="owner-message" class="muted"></div>
    </div>
  </div>

  <h3>è¿”ä¿¡</h3>
  <div id="reply-list" class="reply-list"></div>

  <div class="editor">
    <h4>è¿”ä¿¡ã‚’æŠ•ç¨¿</h4>
    <textarea id="reply-text" placeholder="è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
    <input type="file" id="reply-image" accept="image/*" />
    <div class="row">
      <button id="send-reply-btn">è¿”ä¿¡ã‚’é€ä¿¡</button>
      <span id="reply-message" class="muted"></span>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
  // --- Firebase è¨­å®šï¼ˆindex.html ã¨åŒã˜ï¼‰ ---
  const firebaseConfig = {
    apiKey: "AIzaSyBfstQdl-avHfBWaiPkC0Bzwm_9apWe6Mo",
    authDomain: "school-board-e2ee2.firebaseapp.com",
    projectId: "school-board-e2ee2",
    storageBucket: "school-board-e2ee2.appspot.com",
    messagingSenderId: "257360614407",
    appId: "1:257360614407:web:7cdae33b9ac7d7a671c6a2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
  const $ = (sel) => document.querySelector(sel);
  function escapeHTML(str){ return (str||"").replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  function getParam(name){ return new URLSearchParams(location.search).get(name); }
  function toLocal(dt){ return dt ? new Date(dt.seconds*1000).toLocaleString() : ""; }
  function parseTags(s){ 
    return (s||"")
      .split(/\s+/)
      .map(t=>t.trim())
      .filter(t=>t.startsWith("#") && t.length>1);
  }

  const postId = getParam("id");
  let currentPost = null;
  let currentUser = null;

  // --- åˆæœŸåŒ– ---
  auth.onAuthStateChanged(async (user)=>{
    currentUser = user || null;
    if(!postId){ alert("æŠ•ç¨¿IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
    await loadPost();
    await loadReplies();
    toggleOwnerTools();
  });

  async function loadPost(){
    const doc = await db.collection("posts").doc(postId).get();
    if(!doc.exists){ alert("æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
    currentPost = { id: doc.id, ...doc.data() };

    // æŠ•ç¨¿ç®±ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const box = $("#post-box");
    box.style.background = currentPost.boxColor || "#ffffff";

    $("#post-icon").src = currentPost.userIconUrl || "https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png";
    $("#post-user").textContent = currentPost.userName || "ä¸æ˜";
    $("#post-grade").textContent = `ï¼ˆ${currentPost.userGrade || "æœªè¨­å®š"}ï¼‰`;
    $("#post-time").textContent = toLocal(currentPost.createdAt);
    $("#post-subject").textContent = currentPost.subject || "";
    $("#post-content").textContent = currentPost.content || "";

    if(currentPost.imageUrl){
      $("#post-image").src = currentPost.imageUrl;
      $("#post-image").style.display = "block";
    }else{
      $("#post-image").style.display = "none";
    }

    // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°
    const tagWrap = $("#post-tags");
    tagWrap.innerHTML = "";
    (currentPost.hashtags || []).forEach(tag=>{
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = tag;
      span.addEventListener("click", ()=>{
        // ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ãã®ã‚¿ã‚°æ¤œç´¢ã«é·ç§»
        location.href = `index.html?tag=${encodeURIComponent(tag)}`;
      });
      tagWrap.appendChild(span);
    });

    // æŠ•ç¨¿è€…ç”¨ã®åˆæœŸå€¤
    $("#color-select").value = currentPost.boxColor || "#ffffff";
    $("#tag-input").value = (currentPost.hashtags || []).join(" ");
  }

  function toggleOwnerTools(){
    const isOwner = currentUser && currentPost && currentUser.uid === currentPost.userId;
    $("#owner-tools").style.display = isOwner ? "block" : "none";
  }

  // --- è¿”ä¿¡ä¸€è¦§ ---
  async function loadReplies(){
    const snap = await db.collection("replies")
      .where("postId","==",postId)
      .orderBy("createdAt","asc")
      .get();
    const list = $("#reply-list");
    list.innerHTML = "";
    snap.forEach(doc=>{
      const r = { id: doc.id, ...doc.data() };
      const div = document.createElement("div");
      const self = (r.userId === (currentPost?.userId || ""));
      div.className = "reply" + (self ? " self" : "");
      div.innerHTML = `
        <div style="white-space:pre-wrap;">${escapeHTML(r.content || "")}</div>
        ${r.imageUrl ? `<img src="${escapeHTML(r.imageUrl)}" alt="è¿”ä¿¡ç”»åƒ">` : ""}
        <div class="meta" style="margin-top:.3rem;">
          æŠ•ç¨¿è€…: ${escapeHTML(r.userName||"")} | ${toLocal(r.createdAt)}
        </div>
      `;
      list.appendChild(div);
    });
  }

  // --- è¿”ä¿¡æŠ•ç¨¿ ---
  $("#send-reply-btn").addEventListener("click", async ()=>{
    const msg = $("#reply-message");
    msg.textContent = "";
    const text = $("#reply-text").value.trim();
    const file = $("#reply-image").files[0];

    if(!currentUser){
      msg.textContent = "è¿”ä¿¡ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚å…ˆã«ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    if(!text){ msg.textContent = "è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

    $("#send-reply-btn").disabled = true;
    try{
      let imageUrl = "";
      if(file){
        const fileRef = storage.ref().child(`replies/${postId}/${Date.now()}_${file.name}`);
        await fileRef.put(file);
        imageUrl = await fileRef.getDownloadURL();
      }
      await db.collection("replies").add({
        postId,
        userId: currentUser.uid,
        userName: currentUser.displayName || (currentUser.email||"").split("@")[0],
        content: text,
        imageUrl,
        goodCount: 0,
        userGoodIds: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $("#reply-text").value = "";
      $("#reply-image").value = "";
      msg.textContent = "é€ä¿¡ã—ã¾ã—ãŸã€‚";
      await loadReplies();
    }catch(e){
      console.error(e);
      msg.textContent = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
    $("#send-reply-btn").disabled = false;
  });

  // --- æŠ•ç¨¿è€…é™å®šï¼šè‰²å¤‰æ›´ & ã‚¿ã‚°ç·¨é›† ---
  $("#save-color-btn").addEventListener("click", async ()=>{
    if(!currentUser || currentUser.uid !== currentPost.userId) return;
    const color = $("#color-select").value || "#ffffff";
    $("#owner-message").textContent = "";
    try{
      await db.collection("posts").doc(postId).update({ boxColor: color });
      $("#post-box").style.background = color;
      $("#owner-message").textContent = "èƒŒæ™¯è‰²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚";
    }catch(e){
      console.error(e);
      $("#owner-message").textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  });

  $("#save-tags-btn").addEventListener("click", async ()=>{
    if(!currentUser || currentUser.uid !== currentPost.userId) return;
    const tags = parseTags($("#tag-input").value);
    $("#owner-message").textContent = "";
    try{
      await db.collection("posts").doc(postId).update({ hashtags: tags });
      // å†æç”»
      currentPost.hashtags = tags;
      const tagWrap = $("#post-tags");
      tagWrap.innerHTML = "";
      tags.forEach(tag=>{
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = tag;
        s.addEventListener("click", ()=> location.href=`index.html?tag=${encodeURIComponent(tag)}`);
        tagWrap.appendChild(s);
      });
      $("#owner-message").textContent = "ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚";
    }catch(e){
      console.error(e);
      $("#owner-message").textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  });

  // ã„ã„ã­ãƒœã‚¿ãƒ³
const goodBtn = document.getElementById("good-btn");
const goodCountSpan = document.getElementById("good-count");

async function loadGood() {
  goodCountSpan.textContent = currentPost.goodCount || 0;
}

goodBtn.addEventListener("click", async () => {
  if (!currentUser) {
    alert("ã„ã„ã­ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
    return;
  }
  const docRef = db.collection("posts").doc(postId);

  await db.runTransaction(async (transaction) => {
    const snap = await transaction.get(docRef);
    if (!snap.exists) return;

    const post = snap.data();
    let userGoodIds = post.userGoodIds || [];
    let count = post.goodCount || 0;

    if (userGoodIds.includes(currentUser.uid)) {
      count--;
      userGoodIds = userGoodIds.filter(id => id !== currentUser.uid);
    } else {
      count++;
      userGoodIds.push(currentUser.uid);
    }

    transaction.update(docRef, { goodCount: count, userGoodIds });
  });

  // å†å–å¾—ã—ã¦ç”»é¢ã«åæ˜ 
  const newSnap = await docRef.get();
  const newPost = newSnap.data();
  goodCountSpan.textContent = newPost.goodCount || 0;
});

</script>
</body>
</html>

